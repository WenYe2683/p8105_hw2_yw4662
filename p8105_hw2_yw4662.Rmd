---
title: "p8105-hw2-yw4662"
output: github_document
---

```{r setup}
library(tidyverse)
library(janitor)
library(haven)
library(readxl)
library(dplyr)
library(tidyr)
library(stringr)
library(readr)
library(knitr)
```

## Problem 1

### 1. Clean the data in pols-month.csv

```{r}
pols <- read_csv("./data/pols-month.csv") %>%
  clean_names() %>%
  
  # Split mon into year, month, day as integers
  separate(mon, into = c("year", "month", "day"), sep = "-", convert = TRUE) %>%
  
  # Replace month number with month name
  mutate(month = month.name[month],
         # Create president from indicator cols
         president = if_else(prez_gop == 1, "gop", "dem"),
         president = factor(president, levels = c("gop", "dem"))) %>%
  
  # Remove prez_dem, prez_gop, and day variables
  select(-prez_dem, -prez_gop, -day)

pols
```

### 2. Clean the data in snp.csv

```{r}
snp <- read_csv("./data/snp.csv") %>%
  clean_names() %>%
  
  # Parse the data
  mutate(date = mdy(date),
         year = year(date),
         mon_n = month(date)) %>%
  mutate(month = month.name[mon_n]) %>%
  select(-mon_n, -date) %>%
  
  # Make year & month leading columns
  relocate(year, month, .before = 1) %>%
  
  # Arrange according to year and month
  arrange(year, month(match(month, month.name)))

snp
```

### 3. Tidy the unemployment data

```{r}
unemp <- read_csv("./data/unemployment.csv") %>%
  clean_names() %>%
  pivot_longer(
    cols = jan:dec,
    names_to = "month",
    values_to = "unemployment"
  ) %>%
  mutate(
    year = as.integer(year),
    month = str_to_title(month.name[match(month, tolower(month.abb))]) # matching
  ) %>%
  relocate(year, month, .before = 1) %>%
  arrange(year, match(month, month.name))

unemp
```

### 4. Merge the datasets

```{r}
mm <- factor(month.name, levels = month.name)

pols <- pols %>%
  mutate(
    year = as.integer(year),
    month = factor(month, levels = levels(mm))
  ) %>%
  arrange(year, month)

snp <- snp %>%
  mutate(
    year = as.integer(year),
    month = factor(month, levels = levels(mm))
  ) %>%
  arrange(year, month)

unemp <- unemp %>%
  mutate(
    year = as.integer(year),
    month = factor(month, levels = levels(mm))
  ) %>%
  arrange(year, month)

# Merging
merged <- pols %>%
  left_join(snp, by = c("year", "month")) %>%
  left_join(unemp, by = c("year", "month"))

merged
```

### 5. Comment

The **pols** table contains monthly U.S. politicians counts and a `president` indicator; it spans `r min(pols$year)` - `r max(pols$year)` with `r nrow(pols)` rows. The **snp** table adds monthly S&P returns, and the **unemp** table provides monthly unemployment rates for `r length(unique(unemp$year))` years.

After merging on `year` and `month`, the resulting dataset has `r nrow(merged)` rows Ã— `r ncol(merged)` columns; key variables include `year`, `month`, `president`, `unemployment`, and the S&P return column from `close`.

## Problem 2

### Data cleaning

```{r}
path <- "./data/202509 Trash Wheel Collection Data.xlsx"

# Mr. Trash Wheel
mr_trash <- read_excel(
  path,
  sheet = "Mr. Trash Wheel",   # specify the sheet
  range = cell_limits(c(2,1),c(NA,14)),   # omit non-data rows/columns
  na = c("NA", ".", "")   # treat these as missing
) %>%
  janitor::clean_names() %>%
  filter(!is.na(dumpster)) %>%   # keep only dumpster-specific rows
  mutate(
    date = as.Date(date),
    year = year(date),
    month_num = month(date),
    month = month.name[month_num],
    wheel = "Mr. Trash Wheel")
if (!"sports_balls" %in% names(mr_trash)) mr_trash$sports_balls <- NA_integer_
mr_trash

# Professor Trash Wheel
prof_trash <- read_excel(
  path,
  sheet = "Professor Trash Wheel",
  range = cell_limits(c(2,1),c(NA,13)),
  na = c("NA", ".", "")
) %>%
  clean_names() %>%
  filter(!is.na(dumpster)) %>%
  mutate(
    date = as.Date(date),
    year = year(date),
    month_num = month(date),
    month = month.name[month_num],
    wheel = "Professor Trash Wheel"
  )
prof_trash

# Gwynnda
gwynnda <- read_excel(
  path,
  sheet = "Gwynns Falls Trash Wheel",
  range = cell_limits(c(2,1), c(NA, 12)),
  na = c("NA", ".", "")
) %>%
  clean_names() %>%
  filter(!is.na(dumpster)) %>%
  mutate(
    date = as.Date(date),
    year = year(date),
    month_num = month(date),
    month = month.name[month_num],
    wheel = "Gwynns Falls Trash Wheel"
  )
gwynnda

# Combine
trash_all <- bind_rows(mr_trash, prof_trash, gwynnda) %>%
  arrange(wheel, year, month_num)
trash_all
```

### Commenting

The combined Trash Wheel dataset contains `r nrow(trash_all)` observations spanning `r min(trash_all$year)` - `r max(trash_all$year)`. 

Key variables include `weight_tons`, `volume_cubic_yards`, `cigarette_butts`, along with date categories (`year`, `month`, `date`).

Across the available data, **Professor Trash Wheel** collected `r trash_all %>% filter(wheel == "Professor Trash Wheel") %>% summarise(sum(weight_tons, na.rm=TRUE)) %>% pull()` tons of trash.

In **June 2022**, **Gwynnda** collected `r scales::comma(trash_all %>% filter(wheel == "Gwynns Falls Trash Wheel", year == 2022, month == "June") %>% summarise(sum(cigarette_butts, na.rm = TRUE)) %>% pull())` cigarette butts. 

## Problem 3

### 1. Import and clean the ZIP crosswalk
```{r}
zip <- read_csv("./data/Zip Codes.csv", show_col_types = FALSE) %>%
  clean_names() %>%
  mutate(zip = str_pad(as.character(zip_code), width = 5, pad = "0"))
```

### 2. Import and tidy Zillow ZORI

```{r}
zori_wide <- read_csv("./data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv", show_col_types = FALSE) %>%
  clean_names()

if ("region_name" %in% names(zori_wide)) {
  zori_wide <- zori_wide %>% rename(zip = region_name)
}
zori_wide <- zori_wide %>% mutate(zip = str_pad(as.character(zip), width = 5, side = "left", pad = "0"))
  
  zori <- zori_wide %>%
    pivot_longer(
      cols = starts_with("x20"), 
      names_to = "date_chr",
      values_to = "zori"
    ) %>%
    mutate(
      date = ymd(str_remove(date_chr, "^x") %>% str_replace_all("_", "-")),
      year = year(date),
      month = month(date, label = TRUE, abbr = TRUE)
    ) %>%
    select(zip, date, year, month, zori, city, state, county_name, size_rank)
```

### 3. Merge data and organize

```{r}
zori_full <- zori %>%
  left_join(zip, by = "zip") %>%
  mutate(
    county_src = coalesce(county_name, county),
    borough = case_when(
      county_src == "Bronx County" ~ "Bronx",
      county_src == "Kings County" ~ "Brooklyn",
      county_src == "New York County" ~ "Manhatan",
      county_src == "Queens County" ~ "Queens",
      county_src == "Richmond County" ~ "Staten Island",
      TRUE ~ NA_character_
    )
  ) %>%
  select(-county_src) %>%
  relocate(zip, borough, neighborhood, county_name, city, state, .before = date)
zori_full
```

### 4. Brief description

- There are `r nrow(zori_full)` total observations.
- There are `r n_distinct(zori_full$zip)` unique ZIP codes included.
- There are `r n_distinct(zori_full$neighborhood)` unique neighborhoods.

### 5. ZIPs in ZIP code dataset but not in Zillow dataset

```{r}
zip_only_in_code <- zip %>%
  anti_join(zori_full %>% distinct(zip), by = "zip") %>%
  arrange(zip)

```

### 6. Largest price drop for all ZIPs

```{r}
# Compute the Jan 2021 vs Jan 2020 difference per ZIP
jan_diff <- zori_full %>%
  filter(month == "Jan", year %in% c(2020, 2021)) %>%
  select(zip, year, zori) %>%
  pivot_wider(names_from = year, values_from = zori) %>%
  mutate(across(c(`2020`, `2021`), ~as.numeric(as.character(.)))) %>%
  transmute(zip, jan_diff_21_minus_20 = `2021` - `2020`)

# Add it to zori_full
zori_full <- zori_full %>%
  left_join(jan_diff, by = "zip") %>%
  mutate(jan_diff = as.numeric(jan_diff_21_minus_20))

top10_drop <- zori_full %>%
  distinct(zip, borough, neighborhood, jan_diff) %>%
  arrange(jan_diff) %>%
  slice_head(n = 10)

kable(
  top10_drop,
  digits = 2,
  col.names = c("Zip Code", "Borough", "Neighborhood", "Price Drop"),
  caption = "Top 10 ZIP codes with largest drop in ZORI from Jan 2020 to Jan 2021"
)
```

